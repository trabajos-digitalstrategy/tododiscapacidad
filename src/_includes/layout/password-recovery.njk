<!DOCTYPE html>
<html lang="{{ global_index.lang }}">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ metaTitle }}</title>
  <meta name="robots" content="{{ metaRobots }}" />
  <meta name="description" content="{{ metaDescription }}" />
  <meta name="keywords" content="{{ metaKeywords }}" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ global_index.url }}/assets/static/favicons/favicon-32x32.png" />
  
  <!-- Estilos CSS -->
  <style>
    :root {
      --c-accent: {{ global_index.c_accent }};
      --c-primary: {{ global_index.c_primary }}; 
      --c-secondary: {{ global_index.c_secondary }};
      --bg-dark: {{ global_index.bg_dark }}; 
      --c-bg-dark: {{ global_index.c_bg_dark }}; 
      --bg-light: {{ global_index.bg_light }}; 
      --c-bg-light: {{ global_index.c_bg_light }}; 
      --btn-radius: {{ global_index.btn_radius }}; 
    }
  </style>
  <link rel="stylesheet" href="/assets/css/style.css" />
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body class="password-recovery-page">
  <div class="recovery-container">
    <div class="recovery-card">
      <div class="recovery-header">
        <h1 class="recovery-title">{{ metaTitle }}</h1>
        <p class="recovery-subtitle">Procesando tu solicitud de recuperación...</p>
      </div>
      
      <div id="status" class="status-message" style="display: none;">
        <div id="status-message"></div>
      </div>
      
      <div id="loading" class="loading-spinner" style="display: none;"></div>
      
      <div class="recovery-content">
        {{ content | safe }}
      </div>
      
      <div class="recovery-actions">
        <a href="/" class="btn btn-primary" id="home-btn" style="display: none;">Volver al Inicio</a>
      </div>
    </div>
  </div>

  <script>
    // Función para mostrar mensajes de estado
    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      const statusMessage = document.getElementById('status-message');
      const loading = document.getElementById('loading');
      
      statusMessage.textContent = message;
      status.className = `status-message ${type}`;
      status.style.display = 'block';
      loading.style.display = 'none';
    }

    // Función para mostrar loading
    function showLoading() {
      const loading = document.getElementById('loading');
      const status = document.getElementById('status');
      loading.style.display = 'block';
      status.style.display = 'none';
    }

    // Función para verificar si hay un recovery_token en la URL
    function getRecoveryToken() {
      const hash = window.location.hash;
      const match = hash.match(/recovery_token=([^&]+)/);
      return match ? match[1] : null;
    }

    // Función para validar el token
    function isValidToken(token) {
      return token && token.length > 10 && !token.includes(' ');
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar si Netlify Identity está disponible
      if (typeof netlifyIdentity === 'undefined') {
        showStatus('Error: Netlify Identity no está disponible. Por favor, recarga la página.', 'error');
        document.getElementById('home-btn').style.display = 'inline-block';
        return;
      }

      // Inicializar Netlify Identity
      netlifyIdentity.init();
      
      // Escuchar cuando se inicializa
      netlifyIdentity.on('init', user => {
        const token = getRecoveryToken();
        
        if (token && isValidToken(token)) {
          showLoading();
          console.log('Token de recuperación detectado:', token);
          
          // Intentar recuperar la contraseña con el token
          try {
            netlifyIdentity.open('recover');
          } catch (error) {
            console.error('Error al abrir el modal de recuperación:', error);
            showStatus('Error al procesar el token de recuperación. Por favor, intenta nuevamente.', 'error');
            document.getElementById('home-btn').style.display = 'inline-block';
          }
        } else {
          showStatus('No se encontró un token de recuperación válido en la URL. Por favor, utiliza el enlace que se envió a tu correo electrónico.', 'error');
          document.getElementById('home-btn').style.display = 'inline-block';
        }
      });

      // Escuchar el evento de recuperación exitosa
      netlifyIdentity.on('recover', () => {
        showStatus('¡Perfecto! Ahora puedes establecer tu nueva contraseña.', 'success');
        document.getElementById('home-btn').style.display = 'inline-block';
      });

      // Escuchar errores
      netlifyIdentity.on('error', err => {
        console.error('Error en Netlify Identity:', err);
        showStatus('Hubo un error al procesar la recuperación de contraseña. Por favor, intenta nuevamente.', 'error');
        document.getElementById('home-btn').style.display = 'inline-block';
      });

      // Escuchar cuando se cierra el modal
      netlifyIdentity.on('close', () => {
        const token = getRecoveryToken();
        if (token && isValidToken(token)) {
          // Si hay un token válido pero se cerró el modal, mostrar mensaje
          showStatus('Proceso de recuperación cancelado. Puedes intentar nuevamente.', 'info');
          document.getElementById('home-btn').style.display = 'inline-block';
        }
      });

      // Timeout de seguridad - redirigir si no hay token después de 10 segundos
      setTimeout(() => {
        const token = getRecoveryToken();
        if (!token || !isValidToken(token)) {
          console.log('Redirigiendo al home - no hay token válido');
          window.location.href = '/';
        }
      }, 10000);
    });
  </script>

  <style>
    .password-recovery-page {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--c-primary) 0%, var(--c-secondary) 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    .recovery-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .recovery-card {
      background: white;
      padding: 3rem;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 500px;
      width: 100%;
      position: relative;
    }

    .recovery-header {
      margin-bottom: 2rem;
    }

    .recovery-title {
      color: var(--c-primary);
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .recovery-subtitle {
      color: #666;
      font-size: 1.1rem;
      margin: 0;
    }

    .status-message {
      padding: 1rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      font-weight: 500;
    }

    .status-message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-message.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--c-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .recovery-content {
      margin: 2rem 0;
    }

    .recovery-actions {
      margin-top: 2rem;
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 2rem;
      border: none;
      border-radius: var(--btn-radius);
      text-decoration: none;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background-color: var(--c-primary);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--c-secondary);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 768px) {
      .recovery-container {
        padding: 1rem;
      }
      
      .recovery-card {
        padding: 2rem;
      }
      
      .recovery-title {
        font-size: 1.5rem;
      }
    }
  </style>
</body>
</html>
